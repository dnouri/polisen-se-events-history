<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Reports Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
        #container { display: flex; height: 100vh; }
        #sidebar {
            width: 250px;
            background-color: #f0f0f0;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.collapsed { transform: translateX(-250px); }
        #toggle-sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            z-index: 1000;
            background-color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        #map-container { flex: 1; position: relative; }
        #map { height: 100%; }
        #reports { width: 40%; min-width: 300px; overflow-y: auto; padding: 20px; }
        .report-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .report-item:hover { background-color: #f0f0f0; }
        .report-item.filtered-out {
            opacity: 0;
            transform: scale(0.9);
            height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
        .report-link { color: #0066cc; text-decoration: none; }
        .report-link:hover { text-decoration: underline; }
        .crime-type {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }
        .report-title { font-size: 1.1em; margin: 0 0 5px 0; }
        .report-details {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #666;
        }
        .report-emoji { font-size: 1.5em; margin-right: 10px; }
        .filter-option { margin-bottom: 10px; }
        .filter-option label { display: flex; align-items: center; }
        .filter-option input { margin-right: 10px; }
        #filter-actions { margin-bottom: 20px; }
        #filter-actions button { margin-right: 10px; }
        #search-bar { width: 100%; margin-bottom: 20px; padding: 5px; }
        #filter-info { margin-bottom: 20px; font-style: italic; }
    </style>
</head>
<body>
    <div id="container">
        <button id="toggle-sidebar">‚ò∞</button>
        <div id="sidebar">
            <h2>Filters</h2>
            <input type="text" id="search-bar" placeholder="Search reports...">
            <div id="filter-actions">
                <button id="reset-filters">Reset All</button>
                <button id="select-all-filters">Select All</button>
            </div>
            <div id="filter-options"></div>
            <div id="filter-info"></div>
        </div>
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="reports">
            <h1>Police Reports</h1>
            <div id="reportsList"></div>
        </div>
    </div>

    <div id="loading">Loading data...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([62.0, 15.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const reportsList = document.getElementById('reportsList');
        const loading = document.getElementById('loading');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggle-sidebar');
        const filterOptions = document.getElementById('filter-options');
        const resetFilters = document.getElementById('reset-filters');
        const selectAllFilters = document.getElementById('select-all-filters');
        const searchBar = document.getElementById('search-bar');
        const filterInfo = document.getElementById('filter-info');

        const markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyDistanceMultiplier: 2
        });

        const colorMap = new Map();
        const baseColors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FFA500', '#800080', '#008000', '#FFC0CB', '#A52A2A', '#808080'
        ];

        const emojiMap = {
            'Trafikolycka': 'üöóüí•',
            'Brand': 'üî•',
            'St√∂ld': 'üïµÔ∏è',
            'Misshandel': 'ü§ú',
            'Rattfylleri': 'üç∫üöó',
            'Narkotikabrott': 'üíä',
            'Skottlossning': 'üî´',
            'Explosion': 'üí•',
            'R√•n': 'ü¶π',
            'Inbrott': 'üè†üî®',
            'F√∂rsvunnen person': 'üîçüë§',
            'Vapenbrott': 'üî™'
        };

        let allReports = [];
        let activeFilters = new Set();
        let searchTerm = '';

        function getColorForType(type) {
            if (!colorMap.has(type)) {
                const color = baseColors[colorMap.size % baseColors.length];
                colorMap.set(type, color);
            }
            return colorMap.get(type);
        }

        function getEmojiForType(type) {
            return emojiMap[type] || 'üìã';
        }

        function applyColorToElement(element, type) {
            const color = getColorForType(type);
            element.style.backgroundColor = color;
            element.style.color = getContrastColor(color);
        }

        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1,2), 16);
            const g = parseInt(hexcolor.substr(3,2), 16);
            const b = parseInt(hexcolor.substr(5,2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('sv-SE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function createReportItem(event) {
            const reportItem = document.createElement('div');
            reportItem.className = 'report-item';
            reportItem.id = `report-${event.id}`;

            const typeSpan = document.createElement('span');
            typeSpan.className = 'crime-type';
            typeSpan.textContent = event.type;
            applyColorToElement(typeSpan, event.type);

            reportItem.innerHTML = `
                <h3 class="report-title">${event.name}</h3>
                <div class="report-details">
                    <span class="report-emoji">${getEmojiForType(event.type)}</span>
                    ${typeSpan.outerHTML}
                    <span>${formatDate(event.datetime)}</span>
                    <span style="margin-left: auto;">üìç ${event.location.name}</span>
                </div>
                <p>${event.summary}</p>
                <a href="https://polisen.se${event.url}" class="report-link" target="_blank">Read full report</a>
            `;

            return reportItem;
        }

        function updateFilters() {
            allReports.forEach(report => {
                const shouldShow = (activeFilters.size === 0 || activeFilters.has(report.event.type)) &&
                                   (searchTerm === '' || report.event.name.toLowerCase().includes(searchTerm) ||
                                    report.event.summary.toLowerCase().includes(searchTerm));

                if (report.element) {
                    report.element.classList.toggle('filtered-out', !shouldShow);
                }
                report.marker.setOpacity(shouldShow ? 1 : 0);
             });

            const visibleCount = allReports.filter(report => !report.element.classList.contains('filtered-out')).length;
            filterInfo.textContent = `Showing ${visibleCount} of ${allReports.length} reports`;
        }

        function setupFilterOptions(types) {
            types.forEach(type => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.innerHTML = `
                    <label>
                        <input type="checkbox" value="${type}" checked>
                        <span class="crime-type" style="background-color: ${getColorForType(type)}; color: ${getContrastColor(getColorForType(type))}">${type}</span>
                    </label>
                `;
                filterOptions.appendChild(option);

                option.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        activeFilters.add(type);
                    } else {
                        activeFilters.delete(type);
                    }
                    updateFilters();
                });
            });
        }

        resetFilters.addEventListener('click', () => {
            activeFilters.clear();
            document.querySelectorAll('#filter-options input').forEach(input => input.checked = false);
            updateFilters();
        });

        selectAllFilters.addEventListener('click', () => {
            document.querySelectorAll('#filter-options input').forEach(input => {
                input.checked = true;
                activeFilters.add(input.value);
            });
            updateFilters();
        });

        searchBar.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            updateFilters();
        });

        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        fetch('events.json')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                const types = new Set();

                data.forEach((event, index) => {
                    types.add(event.type);
                    const [lat, lon] = event.location.gps.split(',');

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${getColorForType(event.type)};width:10px;height:10px;border-radius:50%;"></div>`,
                        iconSize: [10, 10],
                        iconAnchor: [5, 5]
                    });

                    const marker = L.marker([lat, lon], {icon: icon});
                    const reportItem = createReportItem(event);
                    reportsList.appendChild(reportItem);

                    marker.on('click', () => {
                        reportItem.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        reportItem.style.backgroundColor = '#ffffd0';
                        setTimeout(() => {
                            reportItem.style.backgroundColor = '';
                        }, 2000);
                });

                    markers.addLayer(marker);
                    allReports.push({ event, element: reportItem, marker });
                });

                map.addLayer(markers);
                setupFilterOptions(Array.from(types).sort());
                updateFilters();

                // Save filter preferences to local storage
                window.addEventListener('beforeunload', () => {
                    localStorage.setItem('activeFilters', JSON.stringify(Array.from(activeFilters)));
                    localStorage.setItem('searchTerm', searchTerm);
                });

                // Load filter preferences from local storage
                const savedFilters = JSON.parse(localStorage.getItem('activeFilters'));
                if (savedFilters) {
                    activeFilters = new Set(savedFilters);
                    document.querySelectorAll('#filter-options input').forEach(input => {
                        input.checked = activeFilters.has(input.value);
                    });
                }
                const savedSearchTerm = localStorage.getItem('searchTerm');
                if (savedSearchTerm) {
                    searchBar.value = savedSearchTerm;
                    searchTerm = savedSearchTerm;
                }
                updateFilters();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loading.textContent = 'Error loading data';
            });

        // Ensure the map fills the available space
        function resizeMap() {
            const mapContainer = document.getElementById('map-container');
            const map = document.getElementById('map');
            map.style.height = `${mapContainer.offsetHeight}px`;
        }

        window.addEventListener('resize', resizeMap);
        resizeMap();
    </script>
</body>
</html>
