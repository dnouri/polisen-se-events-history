<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Reports Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        #container { display: flex; height: 100vh; }
        #map { flex: 1; height: 100%; }
        #reports { flex: 1; overflow-y: auto; padding: 20px; }
        .report-item { margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; }
        .marker-cluster-small { background-color: rgba(181, 226, 140, 0.6); }
        .marker-cluster-small div { background-color: rgba(110, 204, 57, 0.6); }
        .marker-cluster-medium { background-color: rgba(241, 211, 87, 0.6); }
        .marker-cluster-medium div { background-color: rgba(240, 194, 12, 0.6); }
        .marker-cluster-large { background-color: rgba(253, 156, 115, 0.6); }
        .marker-cluster-large div { background-color: rgba(241, 128, 23, 0.6); }
        .report-link { color: #0066cc; text-decoration: none; }
        .report-link:hover { text-decoration: underline; }
        .crime-type { padding: 2px 5px; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="reports">
            <h1>Police Reports</h1>
            <div id="reportsList"></div>
        </div>
    </div>

    <div id="loading">Loading data...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([62.0, 15.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const reportsList = document.getElementById('reportsList');
        const loading = document.getElementById('loading');

        const markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyDistanceMultiplier: 2
        });

        // Centralized color mapping
        const colorMap = new Map();
        const baseColors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FFA500', '#800080', '#008000', '#FFC0CB', '#A52A2A', '#808080'
        ];

        function getColorForType(type) {
            if (!colorMap.has(type)) {
                const color = baseColors[colorMap.size % baseColors.length];
                colorMap.set(type, color);
            }
            return colorMap.get(type);
        }

        function applyColorToElement(element, type) {
            const color = getColorForType(type);
            element.style.backgroundColor = color;
            element.style.color = getContrastColor(color);
        }

        function getContrastColor(hexcolor) {
            // Convert hex to RGB
            const r = parseInt(hexcolor.substr(1,2), 16);
            const g = parseInt(hexcolor.substr(3,2), 16);
            const b = parseInt(hexcolor.substr(5,2), 16);
            // Calculate luminance
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        fetch('events.json')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                data.forEach((event, index) => {
                    const [lat, lon] = event.location.gps.split(',');
                    
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${getColorForType(event.type)};width:10px;height:10px;border-radius:50%;"></div>`,
                        iconSize: [10, 10],
                        iconAnchor: [5, 5]
                    });

                    const marker = L.marker([lat, lon], {icon: icon});
                    
                    const reportItem = document.createElement('div');
                    reportItem.className = 'report-item';
                    reportItem.id = `report-${event.id}`;
                    
                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'crime-type';
                    typeSpan.textContent = event.type;
                    applyColorToElement(typeSpan, event.type);

                    reportItem.innerHTML = `
                        <h3>${event.name}</h3>
                        <p>${event.summary}</p>
                        <p>Date: ${event.datetime}</p>
                        <p>Location: ${event.location.name}</p>
                        <p>Type: ${typeSpan.outerHTML}</p>
                        <a href="https://polisen.se${event.url}" class="report-link" target="_blank">Read full report</a>
                    `;
                    reportsList.appendChild(reportItem);

                    marker.on('click', () => {
                        const targetElement = document.getElementById(`report-${event.id}`);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            targetElement.style.backgroundColor = '#ffffd0';
                            setTimeout(() => {
                                targetElement.style.backgroundColor = '';
                            }, 2000);
                        }
                    });

                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loading.textContent = 'Error loading data';
            });
    </script>
</body>
</html>
