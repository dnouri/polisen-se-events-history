<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Reports Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
        #container { display: flex; height: 100vh; }
        #sidebar { width: 200px; background-color: #f8f8f8; overflow-y: auto; transition: transform 0.3s ease-out; }
        #sidebar.collapsed { transform: translateX(-250px); }
        #map { flex: 1; height: 100%; }
        #reports { width: 350px; overflow-y: auto; padding: 20px; }
        .report-item {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .report-item:hover { background-color: #f0f0f0; }
        .report-title { font-size: 1.1em; margin: 0 0 5px 0; }
        .report-details { display: flex; align-items: center; font-size: 0.9em; color: #666; }
        .report-emoji { font-size: 1.5em; margin-right: 10px; }
        .crime-type {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }
        .report-link { color: #0066cc; text-decoration: none; }
        .report-link:hover { text-decoration: underline; }
        #filter-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .filter-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .filter-button.active {
            background-color: #4CAF50;
            color: white;
        }
        #reset-all, #select-all {
            background-color: #008CBA;
            color: white;
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; z-index: 1001; height: 100%; }
            #map { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="filter-toggle">‚ò∞ Filters</button>
        <div id="sidebar" class="collapsed">
            <button id="select-all" class="filter-button">Select All</button>
            <button id="reset-all" class="filter-button">Reset All</button>
            <div id="category-filters"></div>
        </div>
        <div id="map"></div>
        <div id="reports">
            <h1>Police Reports</h1>
            <div id="reportsList"></div>
        </div>
    </div>

    <div id="loading">Loading data...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([62.0, 15.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const reportsList = document.getElementById('reportsList');
        const loading = document.getElementById('loading');
        const sidebar = document.getElementById('sidebar');
        const filterToggle = document.getElementById('filter-toggle');
        const categoryFilters = document.getElementById('category-filters');
        const selectAllBtn = document.getElementById('select-all');
        const resetAllBtn = document.getElementById('reset-all');

        const markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyDistanceMultiplier: 2
        });

        const colorMap = new Map();
        const baseColors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FFA500', '#800080', '#008000', '#FFC0CB', '#A52A2A', '#808080'
        ];

        const emojiMap = {
            'Trafikolycka': 'üöóüí•',
            'Brand': 'üî•',
            'St√∂ld': 'üïµÔ∏è',
            'Misshandel': 'ü§ú',
            'Rattfylleri': 'üç∫üöó',
            'Narkotikabrott': 'üíä',
            'Skottlossning': 'üî´',
            'Explosion': 'üí•',
            'R√•n': 'ü¶π',
            'Inbrott': 'üè†üî®',
            'F√∂rsvunnen person': 'üîçüë§',
            'Vapenbrott': 'üî™'
        };

        let allMarkers = [];
        let activeFilters = new Set();

        function getColorForType(type) {
            if (!colorMap.has(type)) {
                const color = baseColors[colorMap.size % baseColors.length];
                colorMap.set(type, color);
            }
            return colorMap.get(type);
        }

        function getEmojiForType(type) {
            return emojiMap[type] || 'üìã';
        }

        function applyColorToElement(element, type) {
            const color = getColorForType(type);
            element.style.backgroundColor = color;
            element.style.color = getContrastColor(color);
        }

        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1,2), 16);
            const g = parseInt(hexcolor.substr(3,2), 16);
            const b = parseInt(hexcolor.substr(5,2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('sv-SE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
        }

        function toggleFilter(type) {
            if (activeFilters.has(type)) {
                activeFilters.delete(type);
            } else {
                activeFilters.add(type);
            }
            updateFilters();
            saveFilters();
        }

        function updateFilters() {
            allMarkers.forEach(marker => {
                if (activeFilters.size === 0 || activeFilters.has(marker.crimeType)) {
                    markers.addLayer(marker);
                } else {
                    markers.removeLayer(marker);
                }
            });

            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', activeFilters.has(btn.dataset.type));
            });
        }

        function resetFilters() {
            activeFilters.clear();
            updateFilters();
            saveFilters();
        }

        function selectAllFilters() {
            document.querySelectorAll('.filter-button').forEach(btn => {
                if (btn.dataset.type) {
                    activeFilters.add(btn.dataset.type);
                }
            });
            updateFilters();
            saveFilters();
        }

        function saveFilters() {
            localStorage.setItem('activeFilters', JSON.stringify(Array.from(activeFilters)));
        }

        function loadFilters() {
            const savedFilters = localStorage.getItem('activeFilters');
            if (savedFilters) {
                activeFilters = new Set(JSON.parse(savedFilters));
                updateFilters();
            }
        }

        filterToggle.addEventListener('click', toggleSidebar);
        resetAllBtn.addEventListener('click', resetFilters);
        selectAllBtn.addEventListener('click', selectAllFilters);

        fetch('events.json')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                const categories = new Set();

                data.forEach((event, index) => {
                    const [lat, lon] = event.location.gps.split(',');
                    categories.add(event.type);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${getColorForType(event.type)};width:10px;height:10px;border-radius:50%;"></div>`,
                        iconSize: [10, 10],
                        iconAnchor: [5, 5]
                    });

                    const marker = L.marker([lat, lon], {icon: icon});
                    marker.crimeType = event.type;
                    allMarkers.push(marker);

                    const reportItem = document.createElement('div');
                    reportItem.className = 'report-item';
                    reportItem.id = `report-${event.id}`;

                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'crime-type';
                    typeSpan.textContent = event.type;
                    applyColorToElement(typeSpan, event.type);

                    reportItem.innerHTML = `
                        <h3 class="report-title">${event.name}</h3>
                        <div class="report-details">
                            <span class="report-emoji">${getEmojiForType(event.type)}</span>
                            ${typeSpan.outerHTML}
                            <span>${formatDate(event.datetime)}</span>
                            <span style="margin-left: auto;">üìç ${event.location.name}</span>
                        </div>
                        <p>${event.summary}</p>
                        <a href="https://polisen.se${event.url}" class="report-link" target="_blank">Read full report</a>
                    `;
                    reportsList.appendChild(reportItem);

                    marker.on('click', () => {
                        const targetElement = document.getElementById(`report-${event.id}`);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            targetElement.style.backgroundColor = '#ffffd0';
                            setTimeout(() => {
                                targetElement.style.backgroundColor = '';
                            }, 2000);
                        }
                    });

                    markers.addLayer(marker);
                });

                map.addLayer(markers);

                // Create filter buttons
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.textContent = category;
                    button.className = 'filter-button';
                    button.dataset.type = category;
                    button.addEventListener('click', () => toggleFilter(category));
                    categoryFilters.appendChild(button);
                });

                loadFilters();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loading.textContent = 'Error loading data';
            });
    </script>
</body>
</html>
